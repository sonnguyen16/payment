# Inertia Routes & Controller Contracts

**Feature**: 001-h-th-ng  
**Date**: 2025-10-05

## Overview

Định nghĩa routes và controller contracts cho Inertia.js. Không cần API riêng, controllers trả về Inertia responses với data.

---

## Route Groups

### 1. Authentication Routes (Laravel Breeze)
```php
// routes/auth.php (generated by Breeze)
Route::middleware('guest')->group(function () {
    Route::get('login', [AuthenticatedSessionController::class, 'create'])->name('login');
    Route::post('login', [AuthenticatedSessionController::class, 'store']);
    Route::get('register', [RegisteredUserController::class, 'create'])->name('register');
    Route::post('register', [RegisteredUserController::class, 'store']);
    // ... other auth routes
});
```

### 2. Dashboard Routes
```php
// routes/web.php
Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/dashboard', [DashboardController::class, 'index'])->name('dashboard');
});
```

### 3. Payment Request Routes
```php
Route::middleware(['auth', 'verified'])->group(function () {
    // List & Create
    Route::get('/payment-requests', [PaymentRequestController::class, 'index'])
        ->name('payment-requests.index');
    
    Route::get('/payment-requests/create', [PaymentRequestController::class, 'create'])
        ->name('payment-requests.create')
        ->middleware('can:create,App\Models\PaymentRequest');
    
    Route::post('/payment-requests', [PaymentRequestController::class, 'store'])
        ->name('payment-requests.store')
        ->middleware('can:create,App\Models\PaymentRequest');
    
    // View & Edit
    Route::get('/payment-requests/{paymentRequest}', [PaymentRequestController::class, 'show'])
        ->name('payment-requests.show')
        ->middleware('can:view,paymentRequest');
    
    Route::get('/payment-requests/{paymentRequest}/edit', [PaymentRequestController::class, 'edit'])
        ->name('payment-requests.edit')
        ->middleware('can:update,paymentRequest');
    
    Route::put('/payment-requests/{paymentRequest}', [PaymentRequestController::class, 'update'])
        ->name('payment-requests.update')
        ->middleware('can:update,paymentRequest');
    
    // Actions
    Route::post('/payment-requests/{paymentRequest}/submit', [PaymentRequestController::class, 'submit'])
        ->name('payment-requests.submit')
        ->middleware('can:submit,paymentRequest');
    
    Route::post('/payment-requests/{paymentRequest}/cancel', [PaymentRequestController::class, 'cancel'])
        ->name('payment-requests.cancel')
        ->middleware('can:cancel,paymentRequest');
    
    Route::delete('/payment-requests/{paymentRequest}', [PaymentRequestController::class, 'destroy'])
        ->name('payment-requests.destroy')
        ->middleware('can:delete,paymentRequest');
});
```

### 4. Approval Routes
```php
Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/approvals', [ApprovalController::class, 'index'])
        ->name('approvals.index')
        ->middleware('role:department_head|accountant|ceo');
    
    Route::post('/approvals/{paymentRequest}/approve', [ApprovalController::class, 'approve'])
        ->name('approvals.approve')
        ->middleware('can:approve,paymentRequest');
    
    Route::post('/approvals/{paymentRequest}/reject', [ApprovalController::class, 'reject'])
        ->name('approvals.reject')
        ->middleware('can:reject,paymentRequest');
});
```

### 5. Document Upload Routes
```php
Route::middleware(['auth', 'verified'])->group(function () {
    Route::post('/payment-requests/{paymentRequest}/documents', [DocumentController::class, 'store'])
        ->name('documents.store')
        ->middleware('can:uploadDocument,paymentRequest');
    
    Route::get('/documents/{document}', [DocumentController::class, 'show'])
        ->name('documents.show')
        ->middleware('can:view,document');
    
    Route::delete('/documents/{document}', [DocumentController::class, 'destroy'])
        ->name('documents.destroy')
        ->middleware('can:delete,document');
});
```

### 6. Project Routes
```php
Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/projects', [ProjectController::class, 'index'])
        ->name('projects.index');
    
    Route::get('/projects/{project}', [ProjectController::class, 'show'])
        ->name('projects.show');
});
```

### 7. Notification API Routes (Only for realtime polling)
```php
// routes/api.php
Route::middleware('auth:sanctum')->group(function () {
    Route::get('/notifications/unread', [NotificationController::class, 'unread'])
        ->name('api.notifications.unread');
    
    Route::patch('/notifications/{notification}/read', [NotificationController::class, 'markAsRead'])
        ->name('api.notifications.read');
    
    Route::post('/notifications/read-all', [NotificationController::class, 'markAllAsRead'])
        ->name('api.notifications.read-all');
});
```

---

## Controller Contracts

### DashboardController

#### `index()`
**Purpose**: Hiển thị dashboard với thống kê tổng quan

**Request**: GET `/dashboard`

**Authorization**: Authenticated user

**Response (Inertia)**:
```php
return Inertia::render('Dashboard', [
    'stats' => [
        'total_requests' => int,
        'pending_approval' => int,
        'approved_this_month' => int,
        'total_amount_this_month' => float,
    ],
    'recent_requests' => PaymentRequest[], // Latest 5
    'pending_my_approval' => PaymentRequest[], // If approver role
]);
```

---

### PaymentRequestController

#### `index()`
**Purpose**: Danh sách phiếu đề xuất (có filter, search, pagination)

**Request**: GET `/payment-requests?status=pending&search=...&page=1`

**Query Parameters**:
```php
'status' => 'nullable|in:pending_department_head,pending_accountant,pending_ceo,pending_payment,paid,rejected,cancelled',
'priority' => 'nullable|in:urgent,normal',
'type' => 'nullable|in:advance,payment_proposal,other_expense',
'search' => 'nullable|string|max:255',
'page' => 'nullable|integer|min:1',
```

**Authorization**: Authenticated user (filtered by permissions)

**Response (Inertia)**:
```php
return Inertia::render('PaymentRequests/Index', [
    'requests' => PaymentRequestResource::collection(
        $requests->paginate(20)
    ),
    'filters' => [
        'status' => $request->status,
        'priority' => $request->priority,
        'type' => $request->type,
        'search' => $request->search,
    ],
    'can' => [
        'create' => auth()->user()->can('create', PaymentRequest::class),
    ],
]);
```

#### `create()`
**Purpose**: Form tạo phiếu mới

**Request**: GET `/payment-requests/create`

**Authorization**: `can:create,PaymentRequest`

**Response (Inertia)**:
```php
return Inertia::render('PaymentRequests/Create', [
    'projects' => ProjectResource::collection(Project::active()->get()),
    'types' => PaymentRequestType::cases(),
    'priorities' => Priority::cases(),
]);
```

#### `store()`
**Purpose**: Lưu phiếu mới

**Request**: POST `/payment-requests`

**Request Body**:
```php
[
    'type' => 'required|in:advance,payment_proposal,other_expense',
    'amount' => 'required|numeric|min:0',
    'description' => 'required|string|max:1000',
    'reason' => 'required|string|max:500',
    'expected_date' => 'required|date|after_or_equal:today',
    'priority' => 'required|in:urgent,normal',
    'project_id' => 'nullable|exists:projects,id',
]
```

**Authorization**: `can:create,PaymentRequest`

**Response**:
```php
// Success
return redirect()->route('payment-requests.show', $paymentRequest)
    ->with('success', 'Phiếu đề xuất đã được tạo thành công');

// Validation error (handled by FormRequest)
return back()->withErrors($validator)->withInput();
```

**Side Effects**:
- Tạo PaymentRequest với status = 'draft'
- Tạo ApprovalHistory record (action = 'created')

#### `show()`
**Purpose**: Chi tiết phiếu

**Request**: GET `/payment-requests/{id}`

**Authorization**: `can:view,paymentRequest`

**Response (Inertia)**:
```php
return Inertia::render('PaymentRequests/Show', [
    'request' => new PaymentRequestResource($paymentRequest->load([
        'user',
        'project',
        'currentApprover',
        'documents',
        'approvalHistories.user',
    ])),
    'can' => [
        'update' => auth()->user()->can('update', $paymentRequest),
        'cancel' => auth()->user()->can('cancel', $paymentRequest),
        'delete' => auth()->user()->can('delete', $paymentRequest),
        'approve' => auth()->user()->can('approve', $paymentRequest),
        'reject' => auth()->user()->can('reject', $paymentRequest),
    ],
]);
```

#### `edit()`
**Purpose**: Form chỉnh sửa phiếu

**Request**: GET `/payment-requests/{id}/edit`

**Authorization**: `can:update,paymentRequest`

**Response (Inertia)**:
```php
return Inertia::render('PaymentRequests/Edit', [
    'request' => new PaymentRequestResource($paymentRequest),
    'projects' => ProjectResource::collection(Project::active()->get()),
    'types' => PaymentRequestType::cases(),
    'priorities' => Priority::cases(),
]);
```

#### `update()`
**Purpose**: Cập nhật phiếu

**Request**: PUT `/payment-requests/{id}`

**Request Body**:
```php
[
    'type' => 'required|in:advance,payment_proposal,other_expense',
    'amount' => 'required|numeric|min:0',
    'description' => 'required|string|max:1000',
    'reason' => 'required|string|max:500',
    'expected_date' => 'required|date|after_or_equal:today',
    'priority' => 'required|in:urgent,normal',
    'project_id' => 'nullable|exists:projects,id',
    'update_reason' => 'required|string|max:500', // Lý do chỉnh sửa
]
```

**Authorization**: `can:update,paymentRequest`

**Response**:
```php
return redirect()->route('payment-requests.show', $paymentRequest)
    ->with('success', 'Phiếu đã được cập nhật');
```

**Side Effects**:
- Cập nhật PaymentRequest
- Tạo ApprovalHistory (action = 'updated', changes = diff)
- Reset status về 'pending_department_head' (nếu đã submit)
- Dispatch PaymentRequestUpdated event

#### `submit()`
**Purpose**: Gửi phiếu để duyệt

**Request**: POST `/payment-requests/{id}/submit`

**Authorization**: `can:submit,paymentRequest`

**Response**:
```php
return redirect()->route('payment-requests.show', $paymentRequest)
    ->with('success', 'Phiếu đã được gửi để phê duyệt');
```

**Side Effects**:
- Update status từ 'draft' -> 'pending_department_head'
- Set current_approver_id = department head
- Tạo ApprovalHistory (action = 'submitted')
- Dispatch PaymentRequestSubmitted event
- Send notification to department head

#### `cancel()`
**Purpose**: Hủy phiếu

**Request**: POST `/payment-requests/{id}/cancel`

**Request Body**:
```php
[
    'reason' => 'required|string|max:500',
]
```

**Authorization**: `can:cancel,paymentRequest`

**Response**:
```php
return redirect()->route('payment-requests.index')
    ->with('success', 'Phiếu đã được hủy');
```

**Side Effects**:
- Update status -> 'cancelled'
- Tạo ApprovalHistory (action = 'cancelled', reason)
- Dispatch PaymentRequestCancelled event

#### `destroy()`
**Purpose**: Xóa phiếu (soft delete)

**Request**: DELETE `/payment-requests/{id}`

**Authorization**: `can:delete,paymentRequest`

**Response**:
```php
return redirect()->route('payment-requests.index')
    ->with('success', 'Phiếu đã được xóa');
```

**Side Effects**:
- Update status -> 'deleted'
- Soft delete PaymentRequest
- Tạo ApprovalHistory (action = 'deleted')

---

### ApprovalController

#### `index()`
**Purpose**: Danh sách phiếu cần duyệt

**Request**: GET `/approvals?status=pending&page=1`

**Authorization**: `role:department_head|accountant|ceo`

**Response (Inertia)**:
```php
return Inertia::render('Approvals/Index', [
    'requests' => PaymentRequestResource::collection(
        $pendingRequests->paginate(20)
    ),
    'stats' => [
        'pending_count' => int,
        'approved_today' => int,
    ],
]);
```

**Business Logic**:
- Department head: Chỉ thấy phiếu của nhân viên trong bộ phận
- Accountant: Chỉ thấy phiếu của offices được assign
- CEO: Thấy tất cả phiếu pending_ceo

#### `approve()`
**Purpose**: Phê duyệt phiếu

**Request**: POST `/approvals/{id}/approve`

**Request Body**:
```php
[
    'note' => 'nullable|string|max:500', // Ghi chú (optional)
]
```

**Authorization**: `can:approve,paymentRequest`

**Response**:
```php
return redirect()->route('approvals.index')
    ->with('success', 'Phiếu đã được phê duyệt');
```

**Side Effects**:
- Update status to next stage (via ApprovalWorkflowService)
- Update current_approver_id
- Tạo ApprovalHistory (action = 'approved')
- Dispatch PaymentRequestApproved event
- Send notification to creator & next approver

#### `reject()`
**Purpose**: Từ chối phiếu

**Request**: POST `/approvals/{id}/reject`

**Request Body**:
```php
[
    'reason' => 'required|string|max:500',
]
```

**Authorization**: `can:reject,paymentRequest`

**Response**:
```php
return redirect()->route('approvals.index')
    ->with('success', 'Phiếu đã bị từ chối');
```

**Side Effects**:
- Update status -> 'rejected'
- Update rejection_reason
- Tạo ApprovalHistory (action = 'rejected', reason)
- Dispatch PaymentRequestRejected event
- Send notification to creator

---

### DocumentController

#### `store()`
**Purpose**: Upload chứng từ

**Request**: POST `/payment-requests/{id}/documents`

**Request Body** (multipart/form-data):
```php
[
    'file' => 'required|file|mimes:pdf,jpg,jpeg,png|max:10240', // 10MB
    'type' => 'required|in:invoice,receipt,contract,other',
    'description' => 'nullable|string|max:255',
]
```

**Authorization**: `can:uploadDocument,paymentRequest`

**Response**:
```php
return back()->with('success', 'Chứng từ đã được tải lên');
```

**Side Effects**:
- Store file in `storage/app/public/documents/{payment_request_id}/`
- Create Document record
- Update PaymentRequest.updated_at

#### `show()`
**Purpose**: Download/view file

**Request**: GET `/documents/{id}`

**Authorization**: `can:view,document`

**Response**:
```php
return Storage::disk('public')->download($document->path, $document->original_name);
```

#### `destroy()`
**Purpose**: Xóa chứng từ

**Request**: DELETE `/documents/{id}`

**Authorization**: `can:delete,document`

**Response**:
```php
return back()->with('success', 'Chứng từ đã được xóa');
```

**Side Effects**:
- Delete file from storage
- Delete Document record

---

### ProjectController

#### `index()`
**Purpose**: Danh sách dự án

**Request**: GET `/projects?status=active`

**Authorization**: Authenticated user

**Response (Inertia)**:
```php
return Inertia::render('Projects/Index', [
    'projects' => ProjectResource::collection(
        Project::with('paymentRequests')->paginate(20)
    ),
]);
```

#### `show()`
**Purpose**: Chi tiết dự án & phiếu liên quan

**Request**: GET `/projects/{id}`

**Authorization**: Authenticated user

**Response (Inertia)**:
```php
return Inertia::render('Projects/Show', [
    'project' => new ProjectResource($project->load('paymentRequests.user')),
    'stats' => [
        'total_requests' => int,
        'total_spent' => float,
        'budget_remaining' => float,
        'utilization_percentage' => float,
    ],
]);
```

---

### NotificationController (API only)

#### `unread()`
**Purpose**: Lấy danh sách thông báo chưa đọc (for polling)

**Request**: GET `/api/notifications/unread`

**Authorization**: `auth:sanctum`

**Response (JSON)**:
```json
{
    "data": [
        {
            "id": "uuid",
            "type": "PaymentRequestApproved",
            "data": {
                "payment_request_id": 123,
                "action": "approved",
                "actor_name": "Nguyễn Văn A",
                "message": "Phiếu #123 đã được phê duyệt",
                "url": "/payment-requests/123"
            },
            "created_at": "2025-10-05T12:00:00Z"
        }
    ],
    "unread_count": 5
}
```

#### `markAsRead()`
**Purpose**: Đánh dấu đã đọc

**Request**: PATCH `/api/notifications/{id}/read`

**Authorization**: `auth:sanctum`

**Response (JSON)**:
```json
{
    "success": true
}
```

#### `markAllAsRead()`
**Purpose**: Đánh dấu tất cả đã đọc

**Request**: POST `/api/notifications/read-all`

**Authorization**: `auth:sanctum`

**Response (JSON)**:
```json
{
    "success": true,
    "marked_count": 10
}
```

---

## Resource Transformers

### PaymentRequestResource
```php
public function toArray($request): array
{
    return [
        'id' => $this->id,
        'type' => $this->type->value,
        'type_label' => $this->type->label(),
        'amount' => $this->amount,
        'description' => $this->description,
        'reason' => $this->reason,
        'expected_date' => $this->expected_date->format('Y-m-d'),
        'priority' => $this->priority->value,
        'priority_label' => $this->priority->label(),
        'status' => $this->status->value,
        'status_label' => $this->status->label(),
        'rejection_reason' => $this->rejection_reason,
        'payment_code' => $this->payment_code,
        'paid_at' => $this->paid_at?->format('Y-m-d H:i:s'),
        'created_at' => $this->created_at->format('Y-m-d H:i:s'),
        'updated_at' => $this->updated_at->format('Y-m-d H:i:s'),
        
        // Relationships
        'user' => new UserResource($this->whenLoaded('user')),
        'project' => new ProjectResource($this->whenLoaded('project')),
        'current_approver' => new UserResource($this->whenLoaded('currentApprover')),
        'documents' => DocumentResource::collection($this->whenLoaded('documents')),
        'approval_histories' => ApprovalHistoryResource::collection($this->whenLoaded('approvalHistories')),
    ];
}
```

---

## Summary

✅ Tất cả routes và controller contracts đã được định nghĩa  
✅ Inertia responses với data structure rõ ràng  
✅ Authorization middleware cho mọi action  
✅ Validation rules chi tiết  
✅ Side effects documented  
✅ API routes chỉ cho notifications polling  

**Next**: Tạo quickstart.md với test scenarios
